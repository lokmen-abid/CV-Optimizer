<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ATS CV Optimizer — Résultats</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Styles pour les sections extraites du CV */
    .cv-section-card { border-left: 4px solid #0d6efd; }
    .cv-section-title { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .cv-section-title .meta { font-size:0.85rem; color:#6c757d; }
    .cv-section-pre { white-space:pre-wrap; overflow:auto; max-height:220px; transition: max-height 0.25s ease; }
    .cv-section-pre.expanded { max-height: 1000px; }
    .section-controls .btn { font-size:0.82rem; }
  </style>
</head>
<body>
  <div class="container py-5">
    <h1 class="mb-4">Résultats de l'analyse</h1>

    <div class="row g-3 mb-4">
      <div class="col-12 col-md-4">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title">Score ATS</h5>
            <p class="display-6 mb-0">{{ ats_score if ats_score is defined else '—' }} / 100</p>
            {% if ats_score is defined %}
              <p class="mt-2 mb-0">
                {% if ats_score >= 80 %}
                  <span class="badge bg-success">Excellent</span>
                {% elif ats_score >= 60 %}
                  <span class="badge bg-warning text-dark">Bon</span>
                {% else %}
                  <span class="badge bg-danger">À améliorer</span>
                {% endif %}
              </p>
            {% endif %}
            <!-- Breakdown -->
            {% if ats_res and ats_res.breakdown %}
            <div class="mt-3 text-start">
              <h6>Sous-scores</h6>
              {% for k, v in ats_res.breakdown.items() %}
                {% set pct = v.pct if v.pct is defined else 0 %}
                {% if pct >= 75 %}
                  {% set bar_class = 'bg-success' %}
                {% elif pct >= 50 %}
                  {% set bar_class = 'bg-warning' %}
                {% else %}
                  {% set bar_class = 'bg-danger' %}
                {% endif %}
                <div class="mb-2">
                  <div class="d-flex justify-content-between">
                    <small class="text-capitalize">{{ k.replace('_', ' ') }}</small>
                    <small>{{ pct }}%</small>
                  </div>
                  <div class="progress" style="height:8px;">
                    <div class="progress-bar {{ bar_class }}" role="progressbar" style="width: {{ pct }}%;" aria-valuenow="{{ pct }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-12 col-md-8">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Match CV ↔ JD</h5>
            {% if match_results %}
              <div class="mb-2">
                <strong>Similarity (TF-IDF):</strong> {{ match_results.similarity_score }}% <small class="text-muted">({{ match_results.tfidf_method }})</small>
              </div>
              <div class="mb-2">
                <strong>Keyword overlap:</strong> {{ match_results.keyword_match }}%
              </div>
               {% if match_results.embed_score is defined %}
                 <div><strong>Embedding similarity:</strong> {{ match_results.embed_score }}% <small class="text-muted">({{ match_results.embed_method }})</small></div>
               {% endif %}
             {% else %}
               <p class="text-muted">Aucune comparaison disponible.</p>
             {% endif %}

             {% if recommendations %}
               <hr>
               <h6>Recommandations</h6>
               <ul>
                 {% for r in recommendations %}
                   <li>{{ r }}</li>
                 {% endfor %}
               </ul>
             {% endif %}

           </div>
         </div>
       </div>
     </div>

    <div class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Job Description</h5>
        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#jdBlock" aria-expanded="false" aria-controls="jdBlock">Afficher / Cacher</button>
      </div>
      <div class="collapse" id="jdBlock">
        <div class="card card-body bg-light">
          <pre class="mb-0" style="white-space:pre-wrap;">{{ job_description or 'Aucune description fournie' }}</pre>
        </div>
      </div>
    </div>

    <div class="mb-4">
      <h5>Sections extraites du CV</h5>
      {% if cv_sections %}
        <div class="row">
          {% for name, content in cv_sections.items() %}
            {% set wc = (content.split()|length) if content else 0 %}
            <div class="col-12 col-md-6 mb-3">
              <div class="card h-100 cv-section-card shadow-sm">
                <div class="card-body d-flex flex-column">
                  <div class="cv-section-title mb-2">
                    <h6 class="card-title text-capitalize mb-0">{{ name }}</h6>
                    <div class="meta d-flex align-items-center gap-2">
                      <span class="badge bg-secondary">{{ wc }} mots</span>
                      <div class="section-controls btn-group" role="group" aria-label="Contrôles section">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="copySection({{ loop.index0 }}, this)">Copier</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleSection({{ loop.index0 }}, this)">Déplier</button>
                      </div>
                    </div>
                  </div>
                  <pre id="sec-{{ loop.index0 }}" class="cv-section-pre mb-0">{{ content or '—' }}</pre>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">Aucune section extraite.</p>
      {% endif %}
    </div>

    <a href="/" class="btn btn-secondary">Retour</a>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Fonctions pour copier et déplier les sections
    function toggleSection(idx, btn) {
      const el = document.getElementById('sec-' + idx);
      if (!el) return;
      const expanded = el.classList.toggle('expanded');
      btn.textContent = expanded ? 'Réduire' : 'Déplier';
    }

    function copySection(idx, btn) {
      const el = document.getElementById('sec-' + idx);
      if (!el) return;
      const text = el.innerText || el.textContent || '';
      navigator.clipboard && navigator.clipboard.writeText(text).then(function(){
        const orig = btn.textContent;
        btn.textContent = 'Copié !';
        setTimeout(()=> btn.textContent = orig, 1400);
      }).catch(function(){
        // fallback: sélectionner et copier via execCommand
        try {
          const range = document.createRange();
          range.selectNodeContents(el);
          const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
          document.execCommand('copy');
          sel.removeAllRanges();
          const orig = btn.textContent;
          btn.textContent = 'Copié !';
          setTimeout(()=> btn.textContent = orig, 1400);
        } catch(e) {
          console.debug('Copie impossible', e);
        }
      });
    }
  </script>
</body>
</html>
